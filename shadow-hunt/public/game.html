<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>BUNDLED - SHADOW HUNT</title>

  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/game.css" />

  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    canvas { display: block; }
    .hidden { display: none !important; }
    #lobby-ui {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; color: #fff; font-family: 'Courier New', monospace;
        display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10;
    }
    #start-game-btn { 
        margin-top: 20px; padding: 10px 20px; font-size: 1.2em; 
        background: #0f0; color: #000; border: none; cursor: pointer; 
    }
  </style>
</head>
<body>

  <div id="lobby-ui">
      <h1 id="display-room-id"></h1>
      <p id="status-text"></p>
      <button id="start-game-btn" class="hidden">START GAME</button>
  </div>
  
  <div id="loading" class="hidden">LOADING...</div>
  <canvas id="game"></canvas>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Game Engine Globals & Canvas Setup
    (function () {
      window.CONFIG = {}; window.STATE = {}; window.PLAYER = {};
      window.MAP = {}; window.GAME = {};
      const canvas = document.getElementById('game');
      window.__GAME__ = {
        canvas, ctx: canvas.getContext('2d'),
        hideLobby() { document.getElementById('lobby-ui').classList.add('hidden'); },
        showLobby() { document.getElementById('lobby-ui').classList.remove('hidden'); }
      };
      function resize() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr; canvas.height = window.innerHeight * dpr;
        canvas.style.width = `${window.innerWidth}px`; canvas.style.height = `${window.innerHeight}px`;
      }
      window.addEventListener('resize', resize); resize();
    })();
  </script>

  <!-- 
  ==============================================================
  ALL GAME SCRIPTS ARE NOW BUNDLED INTO A SINGLE FILE 
  ==============================================================
  -->
  <script src="js/game.bundle.js"></script>

  <script>
    // Main Game Orchestrator (Lobby Logic)
    window.addEventListener('load', function() {
      const params = new URLSearchParams(location.search);
      const mode = params.get('mode');
      const room = params.get('room');
      const role = params.get('role');

      const uiRoom = document.getElementById('display-room-id');
      const uiStatus = document.getElementById('status-text');
      const uiStartBtn = document.getElementById('start-game-btn');

      function startGame() {
          if (window.GAME && GAME.start) {
              __GAME__.hideLobby();
              GAME.start();
          } else {
              console.error('GAME.start not found! The bundle may have failed to load.');
          }
      }

      if (mode === 'single') {
          uiRoom.textContent = 'OFFLINE';
          uiStatus.textContent = 'VS BOT';
          NETWORK.initOffline(startGame);

      } else if (mode === 'online' && room && role) {
          const isHost = role === 'host';
          uiRoom.textContent = `ROOM: ${room}`;
          uiStartBtn.addEventListener('click', () => NETWORK.signalStartGame());

          const callbacks = {
              onReady: () => {
                  __GAME__.showLobby();
                  uiStatus.textContent = isHost ? 'WAITING FOR PLAYER...' : 'CONNECTED. WAITING FOR HOST...';
              },
              onOpponentJoined: () => {
                  if(isHost) {
                      uiStatus.textContent = 'PLAYER JOINED. YOU CAN START.';
                      uiStartBtn.classList.remove('hidden');
                  }
              },
              onGameStart: () => {
                  startGame();
              },
              onStateUpdate: (newState) => {
                  if (newState.players) STATE.players = newState.players;
                  if (newState.system) {
                      STATE.system.tick = newState.system.tick;
                      STATE.system.winner = newState.system.winner;
                      if(newState.system.inCountdown) STATE.setPlayable(false);
                  }
              }
          };

          NETWORK.init(room, role, callbacks);

      } else {
          location.href = 'index.html';
      }
    });
  </script>

</body>
</html>
